# Privacy Fields Migration Instructions

## New Privacy Fields Added

Three new privacy control fields have been added to the User model:

1. **`is_profile_public`** - Control search engine indexing
2. **`gamification_is_public`** - Control gamification data visibility
3. **`allow_llm_training`** - Control LLM training opt-in

## Migration Steps

### 1. Create Migration

```bash
# From project root
python manage.py makemigrations users
```

Expected output:
```
Migrations for 'users':
  core/users/migrations/0XXX_add_privacy_fields.py
    - Add field is_profile_public to user
    - Add field gamification_is_public to user
    - Add field allow_llm_training to user
    - Add index for is_profile_public
```

### 2. Review Migration

The migration file should look like:

```python
# Generated by Django X.X on YYYY-MM-DD

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('users', '0XXX_previous_migration'),
    ]

    operations = [
        migrations.AddField(
            model_name='user',
            name='is_profile_public',
            field=models.BooleanField(
                default=True,
                db_index=True,
                help_text='Allow profile to appear in search engines and sitemaps. Opt-out for privacy.'
            ),
        ),
        migrations.AddField(
            model_name='user',
            name='gamification_is_public',
            field=models.BooleanField(
                default=True,
                help_text='Show points, level, tier, and achievements on public profile'
            ),
        ),
        migrations.AddField(
            model_name='user',
            name='allow_llm_training',
            field=models.BooleanField(
                default=False,
                help_text='Allow AI models (like ChatGPT) to use profile data for training'
            ),
        ),
    ]
```

### 3. Run Migration

```bash
python manage.py migrate users
```

Expected output:
```
Operations to perform:
  Apply all migrations: users
Running migrations:
  Applying users.0XXX_add_privacy_fields... OK
```

### 4. Verify Migration

```bash
# Check migration status
python manage.py showmigrations users

# Should show [X] for the new migration

# Test in Django shell
python manage.py shell
```

```python
from core.users.models import User

# Create test user
user = User.objects.first()

# Check new fields exist
print(user.is_profile_public)  # Should print: True
print(user.gamification_is_public)  # Should print: True
print(user.allow_llm_training)  # Should print: False

# Test privacy controls
user.is_profile_public = False
user.save()
print("Privacy controls working!")
```

### 5. Clear Sitemap Cache

After migration, clear the sitemap cache to reflect privacy changes:

```bash
python manage.py shell
```

```python
from django.core.cache import cache

# Clear sitemap caches
cache.delete('sitemap_profiles_v1')
cache.delete('sitemap_projects_v1')
cache.delete('sitemap_tools_v1')

print("Sitemap caches cleared!")
```

Or via Redis CLI:
```bash
redis-cli
> DEL allthrive:sitemap_profiles_v1
> DEL allthrive:sitemap_projects_v1
> DEL allthrive:sitemap_tools_v1
```

## Default Values

All existing users will have these defaults after migration:

- `is_profile_public`: `True` (existing behavior - no breaking changes)
- `gamification_is_public`: `True` (existing behavior)
- `allow_llm_training`: `False` (privacy-first - users must opt-in)

## Testing Privacy Controls

### Test Profile Privacy

```bash
# 1. Create test user with private profile
python manage.py shell
```

```python
from core.users.models import User

user = User.objects.create_user(
    username='private_test',
    email='private@test.com',
    is_profile_public=False
)
user.save()
```

```bash
# 2. Check sitemap
curl http://localhost:8000/sitemap.xml | grep "private_test"
# Should return nothing (user opted out)

# 3. Profile still accessible directly
curl http://localhost:3000/@private_test
# Should work (just not in search engines)
```

### Test Gamification Privacy

```python
from core.users.models import User

user = User.objects.get(username='testuser')
user.gamification_is_public = False
user.save()

# Check API response
```

```bash
curl http://localhost:8000/api/v1/users/explore/ | jq
# Should NOT include points, level, tier for this user
```

### Test LLM Blocking

```bash
# Test with GPTBot user agent
curl -A "GPTBot" http://localhost:3000/@testuser
# Should see blocking in robots.txt

# Test with normal browser
curl -A "Mozilla/5.0" http://localhost:3000/@testuser
# Should work normally
```

## Frontend Integration (TODO)

After migration, add privacy controls to user settings:

```tsx
// In AccountSettingsPage.tsx or similar

<div className="privacy-settings">
  <h2>Privacy Settings</h2>
  
  <Toggle
    label="Make my profile discoverable in search engines"
    description="Allow Google, Bing, etc. to index your profile"
    checked={user.is_profile_public}
    onChange={(checked) => updatePrivacy({ is_profile_public: checked })}
  />
  
  <Toggle
    label="Show my points, level, and achievements publicly"
    description="Display gamification progress on your public profile"
    checked={user.gamification_is_public}
    onChange={(checked) => updatePrivacy({ gamification_is_public: checked })}
  />
  
  <Toggle
    label="Allow AI models to learn from my public profile"
    description="Opt-in to let AI models like ChatGPT use your public data for training"
    checked={user.allow_llm_training}
    onChange={(checked) => updatePrivacy({ allow_llm_training: checked })}
  />
</div>
```

## Rollback (If Needed)

If issues occur, rollback the migration:

```bash
# Rollback to previous migration
python manage.py migrate users 0XXX_previous_migration

# Delete migration file
rm core/users/migrations/0XXX_add_privacy_fields.py

# Revert code changes if needed
git checkout HEAD -- core/users/models.py
```

## Post-Migration Checklist

- [ ] Migration created successfully
- [ ] Migration runs without errors
- [ ] New fields accessible in Django shell
- [ ] Sitemap caches cleared
- [ ] Profile privacy tested (users can opt-out)
- [ ] Gamification privacy tested (data hidden when opted out)
- [ ] LLM blocking tested (robots.txt rules work)
- [ ] API respects privacy flags
- [ ] No breaking changes for existing users

## Support

If you encounter issues:
1. Check migration file is correct
2. Verify database schema: `python manage.py sqlmigrate users 0XXX`
3. Check logs: `tail -f logs/django.log`
4. Test in development first before production

---

**Status:** Ready for migration  
**Breaking Changes:** None (all defaults preserve existing behavior)  
**Database Impact:** 3 new columns + 1 index on User table
