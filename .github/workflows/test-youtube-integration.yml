name: YouTube Integration Tests

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'core/integrations/youtube/**'
      - 'core/social/**'
      - 'services/social_oauth_service.py'
      - '.github/workflows/test-youtube-integration.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'core/integrations/youtube/**'
      - 'core/social/**'
      - 'services/social_oauth_service.py'

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_allthrive_ai
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis/redis-stack-server:latest
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    env:
      # Django settings
      DJANGO_SETTINGS_MODULE: config.settings
      SECRET_KEY: test-secret-key-for-ci-only-not-production
      DEBUG: False

      # Database
      DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test_allthrive_ai

      # Redis
      REDIS_URL: redis://localhost:6379/0

      # Disable external services for tests
      AZURE_OPENAI_API_KEY: dummy-key-for-tests
      AZURE_OPENAI_ENDPOINT: https://dummy.openai.azure.com
      AZURE_OPENAI_DEPLOYMENT_NAME: gpt-4
      AZURE_OPENAI_API_VERSION: 2024-02-01

      # OAuth (not needed for tests but required by settings)
      GOOGLE_CLIENT_ID: test-client-id
      GOOGLE_CLIENT_SECRET: test-client-secret
      GITHUB_CLIENT_ID: test-client-id
      GITHUB_CLIENT_SECRET: test-client-secret

      # Other required settings
      ALLOWED_HOSTS: localhost,127.0.0.1
      SITE_URL: http://localhost:8000
      FRONTEND_URL: http://localhost:3000

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y postgresql-client

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Wait for PostgreSQL
      run: |
        until pg_isready -h localhost -p 5432 -U postgres; do
          echo "Waiting for postgres..."
          sleep 2
        done

    - name: Run migrations
      run: |
        python manage.py migrate --noinput

    - name: Run YouTube integration tests
      run: |
        python manage.py test core.integrations.youtube.tests.test_youtube_integration --verbosity=2 --keepdb

    - name: Generate test coverage report (optional)
      if: always()
      run: |
        pip install coverage
        coverage run --source='core/integrations/youtube' manage.py test core.integrations.youtube.tests.test_youtube_integration
        coverage report -m
        coverage html

    - name: Upload coverage report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: htmlcov/
        retention-days: 7

  # Optional: Run linting and type checking
  lint:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install linting tools
      run: |
        pip install flake8 black isort mypy

    - name: Run Black (code formatting)
      run: |
        black --check core/integrations/youtube/

    - name: Run isort (import sorting)
      run: |
        isort --check-only core/integrations/youtube/

    - name: Run flake8 (linting)
      run: |
        flake8 core/integrations/youtube/ --max-line-length=120 --exclude=migrations

    - name: Run mypy (type checking)
      continue-on-error: true  # Type hints are optional for now
      run: |
        mypy core/integrations/youtube/ --ignore-missing-imports
