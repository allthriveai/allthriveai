name: Nightly Deep E2E Tests

# Run nightly at 2 AM UTC (9 PM EST), or manually trigger
on:
  schedule:
    - cron: '0 2 * * *'  # 2 AM UTC daily
  workflow_dispatch:
    inputs:
      test_suite:
        description: 'Test suite to run'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - chat
          - battles
          - learning
          - community

# Only allow one nightly run at a time
concurrency:
  group: nightly-deep-e2e
  cancel-in-progress: true

jobs:
  deep-e2e-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 60  # 1 hour max for all tests

    services:
      postgres:
        image: postgres:18-alpine
        env:
          POSTGRES_DB: allthrive_ai
          POSTGRES_USER: allthrive
          POSTGRES_PASSWORD: allthrive
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U allthrive -d allthrive_ai"
          --health-interval 5s
          --health-timeout 5s
          --health-retries 5
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 5s
          --health-timeout 5s
          --health-retries 5

    env:
      # Django configuration
      DATABASE_URL: postgresql://allthrive:allthrive@localhost:5432/allthrive_ai
      SECRET_KEY: nightly-test-secret-key
      DEBUG: "False"
      SECURE_SSL_REDIRECT: "False"
      ALLOWED_HOSTS: "localhost,127.0.0.1"
      CORS_ALLOWED_ORIGINS: "http://localhost:3000,http://127.0.0.1:3000"
      PYTHONUNBUFFERED: "1"
      # Redis
      REDIS_URL: redis://localhost:6379/0
      CACHE_URL: redis://localhost:6379/2
      CELERY_BROKER_URL: redis://localhost:6379/0
      CELERY_RESULT_BACKEND: redis://localhost:6379/0
      # Auth
      COOKIE_DOMAIN: ""
      CSRF_TRUSTED_ORIGINS: "http://localhost:3000,http://127.0.0.1:3000"
      # AI API keys (from secrets)
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      # Deep E2E flag
      RUN_DEEP_E2E: "true"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: 'requirements.txt'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'frontend/package-lock.json'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Install Node dependencies
        working-directory: frontend
        run: npm ci

      - name: Install Playwright browsers
        working-directory: frontend
        run: npx playwright install --with-deps chromium

      - name: Wait for Postgres
        run: |
          python - <<'PY'
          import os, time, psycopg2
          url = os.environ['DATABASE_URL']
          for i in range(60):
              try:
                  psycopg2.connect(url).close()
                  print('DB ready')
                  break
              except Exception as e:
                  print('Waiting for DB...', e)
                  time.sleep(1)
          else:
              raise SystemExit('Database not available')
          PY

      - name: Setup database
        run: |
          python manage.py migrate --noinput
          python manage.py create_test_users --quiet || true

      - name: Start backend server
        run: |
          python manage.py runserver 8000 &
          sleep 10
          curl -f http://localhost:8000/api/v1/health/ || echo "Backend health check failed"
        env:
          DJANGO_SETTINGS_MODULE: config.settings

      - name: Start frontend server
        working-directory: frontend
        run: |
          npm run dev &
          sleep 15
          curl -f http://localhost:3000/ || echo "Frontend startup in progress..."
        env:
          VITE_API_PROXY_TARGET: http://127.0.0.1:8000
          VITE_WS_URL: ws://127.0.0.1:8000

      - name: Run Deep E2E Tests - All
        if: github.event.inputs.test_suite == 'all' || github.event.inputs.test_suite == ''
        working-directory: frontend
        run: |
          npx playwright test --project=deep --reporter=html
        env:
          TEST_USER_EMAIL: ${{ secrets.E2E_TEST_USER_EMAIL }}
          TEST_USER_PASSWORD: ${{ secrets.E2E_TEST_USER_PASSWORD }}

      - name: Run Deep E2E Tests - Chat Only
        if: github.event.inputs.test_suite == 'chat'
        working-directory: frontend
        run: |
          npx playwright test e2e/deep/chat*.spec.ts --project=deep --reporter=html
        env:
          TEST_USER_EMAIL: ${{ secrets.E2E_TEST_USER_EMAIL }}
          TEST_USER_PASSWORD: ${{ secrets.E2E_TEST_USER_PASSWORD }}

      - name: Run Deep E2E Tests - Battles Only
        if: github.event.inputs.test_suite == 'battles'
        working-directory: frontend
        run: |
          npx playwright test e2e/deep/battles*.spec.ts --project=deep --reporter=html
        env:
          TEST_USER_EMAIL: ${{ secrets.E2E_TEST_USER_EMAIL }}
          TEST_USER_PASSWORD: ${{ secrets.E2E_TEST_USER_PASSWORD }}

      - name: Run Deep E2E Tests - Learning Only
        if: github.event.inputs.test_suite == 'learning'
        working-directory: frontend
        run: |
          npx playwright test e2e/deep/learning*.spec.ts --project=deep --reporter=html
        env:
          TEST_USER_EMAIL: ${{ secrets.E2E_TEST_USER_EMAIL }}
          TEST_USER_PASSWORD: ${{ secrets.E2E_TEST_USER_PASSWORD }}

      - name: Run Deep E2E Tests - Community Only
        if: github.event.inputs.test_suite == 'community'
        working-directory: frontend
        run: |
          npx playwright test e2e/deep/community*.spec.ts --project=deep --reporter=html
        env:
          TEST_USER_EMAIL: ${{ secrets.E2E_TEST_USER_EMAIL }}
          TEST_USER_PASSWORD: ${{ secrets.E2E_TEST_USER_PASSWORD }}

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: deep-e2e-test-results-${{ github.run_id }}
          path: |
            frontend/playwright-report/
            frontend/test-results/
          retention-days: 14

      - name: Upload failure videos
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: deep-e2e-failure-videos-${{ github.run_id }}
          path: frontend/test-results/**/*.webm
          retention-days: 7

  notify-on-failure:
    needs: deep-e2e-tests
    if: failure()
    runs-on: ubuntu-latest
    steps:
      - name: Create issue for failures
        uses: actions/github-script@v7
        with:
          script: |
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const title = `Nightly Deep E2E Tests Failed - ${new Date().toISOString().split('T')[0]}`;
            const body = `## Deep E2E Test Failure\n\n` +
              `The nightly deep E2E tests failed.\n\n` +
              `**Run URL:** ${runUrl}\n\n` +
              `Please investigate and fix any regressions.\n\n` +
              `### Common Causes\n` +
              `- AI response quality degradation\n` +
              `- WebSocket connection issues\n` +
              `- UI changes breaking selectors\n` +
              `- Backend API changes\n`;

            // Check for existing open issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'deep-e2e-failure',
              per_page: 1
            });

            if (issues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['deep-e2e-failure', 'automated']
              });
            } else {
              // Comment on existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues.data[0].number,
                body: `Another failure occurred: ${runUrl}`
              });
            }
