#!/usr/bin/env bash
# Pre-push hook script for AllThrive AI
#
# Runs two checks before allowing a push:
# 1. API versioning check - ensures all new API paths use /api/v1
# 2. Critical E2E regression tests - 4 tests that must pass
#
# Usage:
#   - Place this file at repo root as `pre-push`
#   - Configure Git to use it as the pre-push hook:
#       mkdir -p .git/hooks
#       ln -sf "$(pwd)/pre-push" .git/hooks/pre-push
#       chmod +x pre-push
#   - From then on, pushes will be blocked if checks fail
#
# Bypass: git push --no-verify

set -euo pipefail

# Get repo root using git (works regardless of how script is invoked)
REPO_ROOT="$(git rev-parse --show-toplevel)"

# ============================================================
# CHECK 1: API Versioning
# ============================================================
printf '\n[pre-push] Running API versioning check (enforcing /api/v1)...\n'

# Determine the range of commits being pushed compared to the remote tracking branch.
current_branch="$(git rev-parse --abbrev-ref HEAD)"
range=""

if git rev-parse --verify "origin/${current_branch}" >/dev/null 2>&1; then
  # Compare local branch to its remote tracking branch
  range="origin/${current_branch}..HEAD"
else
  # First push: compare against empty tree
  empty_tree="$(git hash-object -t tree /dev/null)"
  range="${empty_tree}..HEAD"
fi

# Get the diff for the range and look for newly added lines containing "/api/"
# that do NOT already include "/api/v1".
violations="$(
  git diff "${range}" -U0 \
    | grep -E '^\+' \
    | grep '/api/' \
    | grep -v '/api/v1/' \
    | grep -v '^\+\+\+' \
    || true
)"

if [ -n "${violations}" ]; then
  printf '\n[pre-push] ERROR: Found new API paths without /api/v1 in diff (%s):\n' "${range}"
  echo "------------------------------------------------------------"
  echo "${violations}"
  echo "------------------------------------------------------------"
  echo "All new internal API endpoints must be versioned as '/api/v1/...'."
  echo "Please update these paths (and any related docs) to use '/api/v1/'."
  echo
  exit 1
fi

printf '[pre-push] API versioning check passed.\n\n'

# ============================================================
# CHECK 2: Critical E2E Regression Tests
# ============================================================
printf '[pre-push] Running critical E2E regression tests...\n'
printf 'This runs 4 critical tests to verify core functionality.\n'
printf 'Estimated time: 4-5 minutes\n'
printf 'Bypass with: git push --no-verify\n\n'

# Check if backend is running
if ! curl -s http://localhost:8000/api/v1/health/ > /dev/null 2>&1; then
  printf '\n[pre-push] SKIPPING E2E tests: Backend not running at localhost:8000\n'
  printf 'Run "make up" first to enable E2E tests, or use --no-verify to skip.\n\n'
  exit 0
fi

# Check if frontend is running or will be started by Playwright
if ! curl -s http://localhost:3000 > /dev/null 2>&1; then
  printf '[pre-push] Frontend not detected at localhost:3000 - Playwright will start it.\n\n'
fi

# Run the critical tests
cd "${REPO_ROOT}/frontend"
if npx playwright test --project=critical; then
  printf '\n[pre-push] All critical E2E tests passed!\n\n'
else
  printf '\n[pre-push] ERROR: Critical E2E tests failed!\n'
  printf 'Fix the failing tests or use "git push --no-verify" to bypass.\n\n'
  exit 1
fi

printf '[pre-push] All checks passed. Push allowed.\n\n'
exit 0
