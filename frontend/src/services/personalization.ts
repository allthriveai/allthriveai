import { api } from './api';
import type {
  Taxonomy,
  UserTag,
  UserPersonalization,
  InteractionType
} from '@/types/models';

/**
 * Get all available taxonomies
 * Fetches all pages if paginated
 */
export async function getTaxonomies(): Promise<Taxonomy[]> {
  let allTaxonomies: Taxonomy[] = [];
  let nextUrl: string | null = '/taxonomies/';

  // Fetch all pages
  while (nextUrl) {
    const response = await api.get(nextUrl);
    const data = response.data;

    // Handle both paginated and non-paginated responses
    if (data.results) {
      allTaxonomies = allTaxonomies.concat(data.results);
      // Extract relative path from next URL
      if (data.next) {
        const url = new URL(data.next);
        nextUrl = url.pathname + url.search;
        // Remove /api/v1 prefix if present since api base already includes it
        nextUrl = nextUrl.replace('/api/v1', '');
      } else {
        nextUrl = null;
      }
    } else {
      allTaxonomies = data;
      nextUrl = null;
    }
  }

  return allTaxonomies;
}

/**
 * Get taxonomies grouped by category
 */
export async function getTaxonomiesByCategory(): Promise<Record<string, Taxonomy[]>> {
  const response = await api.get('/taxonomies/by_category/');
  return response.data;
}

/**
 * Get user's personalization overview
 */
export async function getUserPersonalization(): Promise<UserPersonalization> {
  const response = await api.get('/me/personalization/');
  return response.data;
}

/**
 * Get user's manual tags
 */
export async function getManualTags(): Promise<UserTag[]> {
  const response = await api.get('/me/tags/manual/');
  return response.data;
}

/**
 * Get user's auto-generated tags
 */
export async function getAutoGeneratedTags(): Promise<UserTag[]> {
  const response = await api.get('/me/tags/auto_generated/');
  return response.data;
}

/**
 * Get all user tags
 */
export async function getAllUserTags(): Promise<UserTag[]> {
  const response = await api.get('/me/tags/');
  return response.data;
}

/**
 * Create a single manual tag
 */
export async function createUserTag(data: {
  taxonomy?: number;
  name?: string;
}): Promise<UserTag> {
  const response = await api.post('/me/tags/', data);
  return response.data;
}

/**
 * Create multiple tags from taxonomy selections
 */
export async function bulkCreateTags(taxonomyIds: number[]): Promise<UserTag[]> {
  const response = await api.post('/me/tags/bulk_create/', {
    taxonomy_ids: taxonomyIds,
  });
  return response.data;
}

/**
 * Delete a single tag
 */
export async function deleteUserTag(tagId: number): Promise<void> {
  await api.delete(`/me/tags/${tagId}/`);
}

/**
 * Delete multiple tags
 */
export async function bulkDeleteTags(tagIds: number[]): Promise<{ deleted: number }> {
  const response = await api.delete('/me/tags/bulk_delete/', {
    data: { tag_ids: tagIds },
  });
  return response.data;
}

/**
 * Track a user interaction
 */
export async function trackInteraction(data: {
  interactionType: InteractionType;
  metadata?: Record<string, any>;
  extractedKeywords?: string[];
}): Promise<void> {
  await api.post('/me/interactions/', {
    interaction_type: data.interactionType,
    metadata: data.metadata || {},
    extracted_keywords: data.extractedKeywords || [],
  });
}

/**
 * Personalization settings type
 */
export interface PersonalizationSettings {
  use_topic_selections: boolean;
  learn_from_views: boolean;
  learn_from_likes: boolean;
  consider_skill_level: boolean;
  factor_content_difficulty: boolean;
  use_social_signals: boolean;
  discovery_balance: number;
  allow_time_tracking: boolean;
  allow_scroll_tracking: boolean;
  created_at: string;
  updated_at: string;
}

/**
 * Get user's personalization settings
 */
export async function getPersonalizationSettings(): Promise<PersonalizationSettings> {
  const response = await api.get('/me/personalization/settings/');
  return response.data;
}

/**
 * Update user's personalization settings
 */
export async function updatePersonalizationSettings(
  settings: Partial<PersonalizationSettings>
): Promise<PersonalizationSettings> {
  const response = await api.patch('/me/personalization/settings/', settings);
  return response.data;
}

/**
 * Reset personalization settings to defaults
 */
export async function resetPersonalizationSettings(): Promise<{
  message: string;
  settings: PersonalizationSettings;
}> {
  const response = await api.post('/me/personalization/settings/reset/');
  return response.data;
}

/**
 * Export personalization data response type
 */
export interface PersonalizationExport {
  exported_at: string;
  user: {
    id: number;
    username: string;
  };
  personalization_settings: PersonalizationSettings | null;
  manual_tags: Array<{
    id: number;
    name: string;
    taxonomy: {
      id: number;
      name: string;
      category: string;
    } | null;
    created_at: string;
  }>;
  auto_generated_tags: Array<{
    id: number;
    name: string;
    confidence_score: number;
    interaction_count: number;
    taxonomy: {
      id: number;
      name: string;
      category: string;
    } | null;
    created_at: string;
    updated_at: string;
  }>;
  interaction_summary_last_90_days: Record<string, number>;
}

/**
 * Export all personalization data (GDPR data portability)
 */
export async function exportPersonalizationData(): Promise<PersonalizationExport> {
  const response = await api.get('/me/personalization/export/');
  return response.data;
}

/**
 * Delete personalization data response type
 */
export interface PersonalizationDeleteResult {
  message: string;
  deleted: {
    tags: number;
    interactions: number;
    settings: number;
  };
}

/**
 * Delete all personalization data (GDPR right to erasure)
 */
export async function deletePersonalizationData(): Promise<PersonalizationDeleteResult> {
  const response = await api.delete('/me/personalization/delete/');
  return response.data;
}
